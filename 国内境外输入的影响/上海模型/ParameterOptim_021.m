function [result,ResultsT,ResultsI,ResultsU,ResultsT1,ResultsS,ResultsE,ResultsR]= ParameterOptim_021
tic%输入上海版本
close all
data = load('230.mat');
xi = data.xi;
xi(3:end-2)=(xi(1:end-4)+xi(2:end-3)+xi(3:end-2)+xi(4:end-1))/4;%数据做了光滑处理
%xi=xi*0.4;
%n_in=41012;
x0 = [24183300;1;1;0;1;10;1];%S,E,I,U,T,R
tspan = linspace(0,33,34);
tspan2 = linspace(0,120,121);
a=0.7;%miu1
%b=0.03;%miu2  
c=0.3;%miu3  U的比例
d=1/5;% 潜伏期
e=1/7;%锟斤拷2
f=1/14;% T to R
g=0.01149;%死亡率
k=1/3.8;%I to T
%p=5e-5.*(t>=8)+2e-5.*(t>=0&t<8); %武汉人口流入全国的人群中潜伏者的比例
h1h20 = [0.1 0.1];
result = fminsearch(@ObjFun1,h1h20);
D = ObjFun2(result);
[ResultsT,ResultsI,ResultsU,ResultsT1,ResultsS,ResultsE,ResultsR]=(ObjFun2(result));
plot(xi,'b')
hold on
plot(D,'r')
legend('锟斤拷实锟斤拷锟????','模锟酵硷拷锟斤拷锟斤拷锟????')
    function D = ObjFun1(h1h2)
         h1 = h1h2(1);
          %q = h1(2);
         h2 = h1h2(2);
   fun = @(t,x)[(0.*(t>=0&t<12)+9879.*(t>=12&t<13)+9765.*(t>=13&t<14)+9921.*(t>=14&t<15)+9124.*(t>=15&t<16)+7649.*(t>=16&t<17)+7642.*(t>=17&t<18)+6781.*(t>=18&t<19)+8001.*(t>=19&t<20)+8007.*(t>=20&t<21)+5445.*(t>=21&t<22)+4031.*(t>=22&t<23)+4013.*(t>=23&t<24)+3504.*(t>=24&t<25)+3727.*(t>=25&t<26)+3786.*(t>=26&t<27)+4181.*(t>=27&t<28)+2696.*(t>=28&t<29)+2861.*(t>=29&t<30)+2500.*(t>=30&t<31)+2486.*(t>=31&t<32)+2935.*(t>=32&t<33)+2281.*(t>=33&t<34)+3083.*(t>=34&t<35)+2693.*(t>=35&t<36)+2146.*(t>=36&t<37)+2146.*(t>=37&t<38)+2146.*(t>=38&t<39)+2146.*(t>=39&t<40)+2146.*(t>=40&t<41)+2146.*(t>=41&t<42)+2146.*(t>=42&t<43))-((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6));
((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6))+(0.*(t>=0&t<12)+0.215.*(t>=12&t<13)+0.245079.*(t>=13&t<14)+0.240556.*(t>=14&t<15)+0.205104.*(t>=15&t<16)+0.169562.*(t>=16&t<17)+0.166869.*(t>=17&t<18)+0.14297.*(t>=18&t<19)+0.164035.*(t>=19&t<20)+0.190926.*(t>=20&t<21)+0.104372.*(t>=21&t<22)+0.083828.*(t>=22&t<23)+0.078191.*(t>=23&t<24)+0.067124.*(t>=24&t<25)+0.075167.*(t>=25&t<26)+0.063778.*(t>=26&t<27)+0.10622.*(t>=27&t<28)+0.064742.*(t>=28&t<29)+0.055519.*(t>=29&t<30)+0.030047.*(t>=30&t<31)+0.051749.*(t>=31&t<32)+0.058032.*(t>=32&t<33)+0.047746.*(t>=33&t<34)+0.081953.*(t>=34&t<35)+0.07101.*(t>=35&t<36)+0.031173.*(t>=36&t<37)+0.031003.*(t>=37&t<38)+0.030694.*(t>=38&t<39)+0.030228.*(t>=39&t<40)+0.029601.*(t>=40&t<41)+0.028811.*(t>=41&t<42)+0.027866.*(t>=42&t<43))-x(2)*d;
d*x(2)*a-g*x(3)-(0.95/20*t*(t>=0&t<20)+0.95.*(t>=20))*k*x(3);%检出率
d*x(2)*c-e*x(4);
(0.95/20*t*(t>=0&t<20)+0.95.*(t>=20))*k*x(3)-x(5)*f;
e*x(4)+f*x(5);
x(5)*f];
        [~,x] = ode45(fun,tspan,x0);
        D = sqrt(sum(([x(1,5);x(2:end,5)-x(1:end-1,5)+x(2:end,7)-x(1:end-1,7)]-xi)'.^2))+1e7*(h1<0.0001);
    end
     function [D,I,U,T1,S,E,R] = ObjFun2(h1h2)
         h1 = h1h2(1);
          %q = h1(2);
        h2 = h1h2(2);
     fun = @(t,x)[(0.*(t>=0&t<12)+9879.*(t>=12&t<13)+9765.*(t>=13&t<14)+9921.*(t>=14&t<15)+9124.*(t>=15&t<16)+7649.*(t>=16&t<17)+7642.*(t>=17&t<18)+6781.*(t>=18&t<19)+8001.*(t>=19&t<20)+8007.*(t>=20&t<21)+5445.*(t>=21&t<22)+4031.*(t>=22&t<23)+4013.*(t>=23&t<24)+3504.*(t>=24&t<25)+3727.*(t>=25&t<26)+3786.*(t>=26&t<27)+4181.*(t>=27&t<28)+2696.*(t>=28&t<29)+2861.*(t>=29&t<30)+2500.*(t>=30&t<31)+2486.*(t>=31&t<32)+2935.*(t>=32&t<33)+2281.*(t>=33&t<34)+3083.*(t>=34&t<35)+2693.*(t>=35&t<36)+2146.*(t>=36&t<37)+2146.*(t>=37&t<38)+2146.*(t>=38&t<39)+2146.*(t>=39&t<40)+2146.*(t>=40&t<41)+2146.*(t>=41&t<42)+2146.*(t>=42&t<43))-((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6));
((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6))+(0.*(t>=0&t<12)+0.215.*(t>=12&t<13)+0.245079.*(t>=13&t<14)+0.240556.*(t>=14&t<15)+0.205104.*(t>=15&t<16)+0.169562.*(t>=16&t<17)+0.166869.*(t>=17&t<18)+0.14297.*(t>=18&t<19)+0.164035.*(t>=19&t<20)+0.190926.*(t>=20&t<21)+0.104372.*(t>=21&t<22)+0.083828.*(t>=22&t<23)+0.078191.*(t>=23&t<24)+0.067124.*(t>=24&t<25)+0.075167.*(t>=25&t<26)+0.063778.*(t>=26&t<27)+0.10622.*(t>=27&t<28)+0.064742.*(t>=28&t<29)+0.055519.*(t>=29&t<30)+0.030047.*(t>=30&t<31)+0.051749.*(t>=31&t<32)+0.058032.*(t>=32&t<33)+0.047746.*(t>=33&t<34)+0.081953.*(t>=34&t<35)+0.07101.*(t>=35&t<36)+0.031173.*(t>=36&t<37)+0.031003.*(t>=37&t<38)+0.030694.*(t>=38&t<39)+0.030228.*(t>=39&t<40)+0.029601.*(t>=40&t<41)+0.028811.*(t>=41&t<42)+0.027866.*(t>=42&t<43))-x(2)*d;
d*x(2)*a-g*x(3)-(0.95/20*t*(t>=0&t<20)+0.95.*(t>=20))*k*x(3);%检出率
d*x(2)*c-e*x(4);
(0.95/20*t*(t>=0&t<20)+0.95.*(t>=20))*k*x(3)-x(5)*f;
e*x(4)+f*x(5);
x(5)*f];
        [~,x] = ode45(fun,tspan2,x0);
         D = [x(1,5);x(2:end,5)-x(1:end-1,5)+x(2:end,7)-x(1:end-1,7)];
        I = x(:,3);%实时的I
        U =x(:,4);%实时的U
        T1 =x(:,5);
        S = x(:,1);
        E = x(:,2);
        R = x(:,6);
    end
toc
end
%[a b c d e f g h]= ParameterOptim_021
%(0.*(t>=0&t<12)+0.215.*(t>=12&t<13)+0.245079.*(t>=13&t<14)+0.240556.*(t>=14&t<15)+0.205104.*(t>=15&t<16)+0.169562.*(t>=16&t<17)+0.166869.*(t>=17&t<18)+0.14297.*(t>=18&t<19)+0.164035.*(t>=19&t<20)+0.190926.*(t>=20&t<21)
%+0.104372.*(t>=21&t<22)+0.083828.*(t>=22&t<23)+0.078191.*(t>=23&t<24)+0.067124.*(t>=24&t<25)+0.075167.*(t>=25&t<26)+0.063778.*(t>=26&t<27)+0.10622.*(t>=27&t<28)+0.064742.*(t>=28&t<29)+0.055519.*(t>=29&t<30)+0.030047.*(t>=30&t<31)+0.051749.*(t>=31&t<32)+0.058032.*(t>=32&t<33)
%+0.047746.*(t>=33&t<34)+0.081953.*(t>=34&t<35)+0.07101.*(t>=35&t<36)+0.031173.*(t>=36&t<37)+0.031003.*(t>=37&t<38)+0.030694.*(t>=38&t<39)+0.030228.*(t>=39&t<40)+0.029601.*(t>=40&t<41)+0.028811.*(t>=41&t<42)+0.027866.*(t>=42&t<43))