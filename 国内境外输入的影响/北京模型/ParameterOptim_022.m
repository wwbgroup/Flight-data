function [result,ResultsT,ResultsI,ResultsU,ResultsT1,ResultsS,ResultsE,ResultsR]= ParameterOptim_022
tic%输入北京版本
close all
data = load('231.mat');
xi = data.xi;
xi(3:end-2)=(xi(1:end-4)+xi(2:end-3)+xi(3:end-2)+xi(4:end-1))/4;%数据做了光滑处理
%xi=xi*0.4;
%n_in=41012;
x0 = [21542000;3;1;1;2;0;0];%S,E,I,U,T,R
tspan = linspace(0,37,38);
tspan2 = linspace(0,99,100);
a=0.7;%miu1
%b=0.03;%miu2  
c=0.3;%miu3  U的比例
d=1/5;% 潜伏期
e=1/7;%锟斤拷2
f=1/14;% T to R
g=0.01379;%死亡率
k=1/5;%I to T
%p=5e-5.*(t>=8)+2e-5.*(t>=0&t<8); %武汉人口流入全国的人群中潜伏者的比例
h1h20 = [0.1 0.5];
result = fminsearch(@ObjFun1,h1h20);
D = ObjFun2(result);
[ResultsT,ResultsI,ResultsU,ResultsT1,ResultsS,ResultsE,ResultsR]=(ObjFun2(result));
plot(xi,'b')
hold on
plot(D,'r')
legend('锟斤拷实锟斤拷锟????','模锟酵硷拷锟斤拷锟斤拷锟????')
    function D = ObjFun1(h1h2)
         h1 = h1h2(1);
          %q = h1(2);
         h2 = h1h2(2);
   fun = @(t,x)[(0.*(t>=0&t<12)+4139.*(t>=12&t<13)+4634.*(t>=13&t<14)+4373.*(t>=14&t<15)+3592.*(t>=15&t<16)+3870.*(t>=16&t<17)+3303.*(t>=17&t<18)+3372.*(t>=18&t<19)+3638.*(t>=19&t<20)+3449.*(t>=20&t<21)+2836.*(t>=21&t<22)+2305.*(t>=22&t<23)+2564.*(t>=23&t<24)+1867.*(t>=24&t<25)+2400.*(t>=25&t<26)+2087.*(t>=26&t<27)+2335.*(t>=27&t<28)+2685.*(t>=28&t<29)+2050.*(t>=29&t<30)+2149.*(t>=30&t<31)+1894.*(t>=31&t<32)+2019.*(t>=32&t<33)+1989.*(t>=33&t<34)+2069.*(t>=34&t<35)+2139.*(t>=35&t<36)+1710.*(t>=36&t<37)+1710.*(t>=37&t<38)+1710.*(t>=38&t<39)+1710.*(t>=39&t<40)+1710.*(t>=40&t<41)+1710.*(t>=41&t<42)+1710.*(t>=42&t<43))-((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6));
((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6))+(0.*(t>=0&t<12)+0.132991.*(t>=12&t<13)+0.132991.*(t>=13&t<14)+0.133158.*(t>=14&t<15)+0.11449.*(t>=15&t<16)+0.107227.*(t>=16&t<17)+0.100752.*(t>=17&t<18)+0.091858.*(t>=18&t<19)+0.101766.*(t>=19&t<20)+0.105759.*(t>=20&t<21)+0.0874736.*(t>=21&t<22)+0.071903.*(t>=22&t<23)+0.083121.*(t>=23&t<24)+0.06319.*(t>=24&t<25)+0.073511.*(t>=25&t<26)+0.07741.*(t>=26&t<27)+0.0803881.*(t>=27&t<28)+0.0780176.*(t>=28&t<29)+0.080231.*(t>=29&t<30)+0.0836225.*(t>=30&t<31)+0.085195.*(t>=31&t<32)+0.09762.*(t>=32&t<33)+0.09956.*(t>=33&t<34)+0.11889.*(t>=34&t<35)+0.12923.*(t>=35&t<36)+0.11782.*(t>=36&t<37)+0.12685.*(t>=37&t<38)+0.137681833.*(t>=38&t<39)+0.150691378.*(t>=39&t<40)+0.16632088.*(t>=40&t<41)+0.185058426.*(t>=41&t<42)+0.20743.*(t>=42&t<43))-x(2)*d;
d*x(2)*a-g*x(3)-(1./20*t*(t>=0&t<20)+1.*(t>=20))*k*x(3);%检出率
d*x(2)*c-e*x(4);
(1./20*t*(t>=0&t<20)+1.*(t>=20))*k*x(3)-x(5)*f;
e*x(4)+f*x(5);
x(5)*f];
        [~,x] = ode45(fun,tspan,x0);
        D = sqrt(sum(([x(1,5);x(2:end,5)-x(1:end-1,5)+x(2:end,7)-x(1:end-1,7)]-xi)'.^2))+1e7*(h2<0.001);
    end
     function [D,I,U,T1,S,E,R] = ObjFun2(h1h2)
         h1 = h1h2(1);
          %q = h1(2);
        h2 = h1h2(2);
      fun = @(t,x)[(0.*(t>=0&t<12)+4139.*(t>=12&t<13)+4634.*(t>=13&t<14)+4373.*(t>=14&t<15)+3592.*(t>=15&t<16)+3870.*(t>=16&t<17)+3303.*(t>=17&t<18)+3372.*(t>=18&t<19)+3638.*(t>=19&t<20)+3449.*(t>=20&t<21)+2836.*(t>=21&t<22)+2305.*(t>=22&t<23)+2564.*(t>=23&t<24)+1867.*(t>=24&t<25)+2400.*(t>=25&t<26)+2087.*(t>=26&t<27)+2335.*(t>=27&t<28)+2685.*(t>=28&t<29)+2050.*(t>=29&t<30)+2149.*(t>=30&t<31)+1894.*(t>=31&t<32)+2019.*(t>=32&t<33)+1989.*(t>=33&t<34)+2069.*(t>=34&t<35)+2139.*(t>=35&t<36)+1710.*(t>=36&t<37)+1710.*(t>=37&t<38)+1710.*(t>=38&t<39)+1710.*(t>=39&t<40)+1710.*(t>=40&t<41)+1710.*(t>=41&t<42)+1710.*(t>=42&t<43))-((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6));
((h1*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*(x(2)+x(3)))+h2*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(1)*(1-(0.85/20.*t.*(t>=0&t<20)+0.85.*(t>=20)))*x(4))/(x(1)+x(2)+x(3)+x(4)+x(5)+x(6))+(0.*(t>=0&t<12)+0.132991.*(t>=12&t<13)+0.132991.*(t>=13&t<14)+0.133158.*(t>=14&t<15)+0.11449.*(t>=15&t<16)+0.107227.*(t>=16&t<17)+0.100752.*(t>=17&t<18)+0.091858.*(t>=18&t<19)+0.101766.*(t>=19&t<20)+0.105759.*(t>=20&t<21)+0.0874736.*(t>=21&t<22)+0.071903.*(t>=22&t<23)+0.083121.*(t>=23&t<24)+0.06319.*(t>=24&t<25)+0.073511.*(t>=25&t<26)+0.07741.*(t>=26&t<27)+0.0803881.*(t>=27&t<28)+0.0780176.*(t>=28&t<29)+0.080231.*(t>=29&t<30)+0.0836225.*(t>=30&t<31)+0.085195.*(t>=31&t<32)+0.09762.*(t>=32&t<33)+0.09956.*(t>=33&t<34)+0.11889.*(t>=34&t<35)+0.12923.*(t>=35&t<36)+0.11782.*(t>=36&t<37)+0.12685.*(t>=37&t<38)+0.137681833.*(t>=38&t<39)+0.150691378.*(t>=39&t<40)+0.16632088.*(t>=40&t<41)+0.185058426.*(t>=41&t<42)+0.20743.*(t>=42&t<43))-x(2)*d;
d*x(2)*a-g*x(3)-(1./20*t*(t>=0&t<20)+1.*(t>=20))*k*x(3);%检出率
d*x(2)*c-e*x(4);
(1./20*t*(t>=0&t<20)+1.*(t>=20))*k*x(3)-x(5)*f;
e*x(4)+f*x(5);
x(5)*f];
        [~,x] = ode45(fun,tspan2,x0);
         D = [x(1,5);x(2:end,5)-x(1:end-1,5)+x(2:end,7)-x(1:end-1,7)];
        I = x(:,3);%实时的I
        U =x(:,4);%实时的U
        T1 =x(:,5);
        S = x(:,1);
        E = x(:,2);
        R = x(:,6);
    end
toc
end

%[a b c d e f g h]= ParameterOptim_022
